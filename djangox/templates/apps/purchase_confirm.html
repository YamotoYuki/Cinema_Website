{% extends '_base.html' %}
{% load static %}

{% block title %}購入確認{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/app/purchase_confirm.css' %}">
<style>
  .coupon-section {
    background-color: #1350348e; 
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 25px;
    color: white;
  }
  
  .coupon-select {
    background: white;
    border: 2px solid #ffcc00;
    border-radius: 10px;
    padding: 12px;
    font-size: 1rem;
    width: 100%;
    color: #333;
  }
  
  .discount-info {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    padding: 15px;
    margin-top: 15px;
    font-size: 1.1rem;
    font-weight: 600;
  }
  
  .discount-info i {
    font-size: 1.3rem;
    margin-right: 8px;
  }
  
  .price-breakdown {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 10px;
    padding: 15px;
    margin-top: 15px;
  }
  
  .price-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .price-row:last-child {
    border-bottom: none;
    font-size: 1.2rem;
    font-weight: bold;
    color: #28a745;
  }
  
  .original-price {
    text-decoration: line-through;
    color: #999;
  }
</style>
{% endblock %}

{% block content %}
<div class="div py-5">
  <h2 class="mb-4 text-center">購入内容の確認</h2>

  <div class="card p-4 shadow-sm">
    <h4 style="font-size: 2rem;">{{ movie.title }}</h4>
    <p><strong>上映日時:</strong> {{ selected_datetime }}</p>
    <p><strong>スクリーン:</strong> {{ movie.theater }}</p>
    <p><strong>上映時間:</strong> {{ movie.duration }}分</p>

    <hr>

    <p><strong>選択された座席:</strong> {{ selected_seat_numbers|join:", " }}</p>
    <p><strong>座席数:</strong> {{ selected_seat_count }} 席</p>
    <p><strong>単価:</strong> ¥{{ movie.price|floatformat:"0" }}</p>

    <!-- クーポン選択セクション -->
    {% if available_coupons %}
    <div class="coupon-section">
      <h5 class="mb-3">
        <i class="bi bi-ticket-perforated-fill me-2"></i>
        クーポンを使用する（任意）
      </h5>
      <select name="coupon_id" id="couponSelect" class="coupon-select">
        <option value="">クーポンを選択してください</option>
        {% for coupon in available_coupons %}
        <option value="{{ coupon.id }}" 
                data-type="{{ coupon.discount_type }}" 
                data-value="{{ coupon.discount_value }}">
          {{ coupon.title }} - 
          {% if coupon.discount_type == 'percentage' %}
            {{ coupon.discount_value }}%OFF
          {% elif coupon.discount_type == 'fixed' %}
            ¥{{ coupon.discount_value }}OFF
          {% else %}
            無料
          {% endif %}
          (有効期限: {{ coupon.expiry_date|date:"Y/m/d" }})
        </option>
        {% endfor %}
      </select>
      <div id="discountInfo" class="discount-info" style="display: none;">
        <i class="bi bi-check-circle-fill"></i>
        <span id="discountText"></span>
      </div>
    </div>
    {% endif %}

    <!-- 金額表示 -->
    <div class="price-breakdown">
      <div class="price-row">
        <span>小計:</span>
        <span id="subtotal">¥{{ total_price|floatformat:"0" }}</span>
      </div>
      <div class="price-row" id="discountRow" style="display: none;">
        <span style="color: #dc3545;">
          <i class="bi bi-tag-fill me-1"></i>
          クーポン割引:
        </span>
        <span id="discountAmount" style="color: #dc3545;">-¥0</span>
      </div>
      <div class="price-row">
        <span>合計金額:</span>
        <span id="finalTotal">¥{{ total_price|floatformat:"0" }}</span>
      </div>
    </div>

    <hr>

    <form method="post" action="{% url 'purchase_complete' %}">
      {% csrf_token %}
      <input type="hidden" name="movie_id" value="{{ movie.id }}">
      <input type="hidden" name="coupon_id" id="selectedCouponId" value="">
      {% for seat_id in selected_seat_ids %}
        <input type="hidden" name="seats" value="{{ seat_id }}">
      {% endfor %}

      <label class="form-label fw-bold mb-3">決済方法を選択してください</label>

      <label class="payment-option" for="payment_cash">
        <input type="radio" name="payment_method" id="payment_cash" value="cash" checked>
        <img src="{% static 'logo/genkin.png' %}" alt="現金アイコン">
        現金
      </label>

      <label class="payment-option" for="payment_credit">
        <input type="radio" name="payment_method" id="payment_credit" value="credit_card">
        <img src="{% static 'logo/visa.png' %}" alt="クレジットカードアイコン">
        クレジットカード
      </label>

      <label class="payment-option" for="payment_paypal">
        <input type="radio" name="payment_method" id="payment_paypal" value="paypal">
        <img src="{% static 'logo/paypal.png' %}" alt="PayPalアイコン">
        PayPal
      </label>

      <label class="payment-option" for="payment_merpay">
        <input type="radio" name="payment_method" id="payment_merpay" value="merpay">
        <img src="{% static 'logo/merpay.png' %}" alt="メルペイアイコン">
        メルペイ
      </label>

      <label class="payment-option" for="payment_paypay">
        <input type="radio" name="payment_method" id="payment_paypay" value="paypay">
        <img src="{% static 'logo/paypay.png' %}" alt="PayPayアイコン">
        PayPay
      </label>

      <label class="payment-option" for="payment_convenience">
        <input type="radio" name="payment_method" id="payment_convenience" value="convenience_store">
        <img src="{% static 'logo/konbini2.jpg' %}" alt="コンビニ払いアイコン">
        コンビニ払い
      </label>

      <div class="convenience-options" id="convenienceOptions">
        <label class="convenience-option" for="conbini_7eleven">
          <input type="radio" name="convenience_type" id="conbini_7eleven" value="7eleven">
          <img src="{% static 'logo/seveneleven.png' %}" alt="セブンイレブンアイコン">
          セブンイレブン
        </label>
        <label class="convenience-option" for="conbini_famima">
          <input type="radio" name="convenience_type" id="conbini_famima" value="famima">
          <img src="{% static 'logo/family-mart.jpeg' %}" alt="ファミリーマートアイコン">
          ファミリーマート
        </label>
        <label class="convenience-option" for="conbini_lawson">
          <input type="radio" name="convenience_type" id="conbini_lawson" value="lawson">
          <img src="{% static 'logo/lawson.jpg' %}" alt="ローソンアイコン">
          ローソン
        </label>
        <label class="convenience-option" for="conbini_daily">
          <input type="radio" name="convenience_type" id="conbini_daily" value="daily">
          <img src="{% static 'logo/daily.jpeg' %}" alt="デイリーヤマザキアイコン">
          デイリーヤマザキ
        </label>
      </div>

      <button type="submit" class="btn btn-success mt-3">購入を確定する</button>
    </form>

    <div class="mt-3">
      <a href="{% url 'seat_select' movie.id %}" class="btn btn-secondary">座席を選び直す</a>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const paymentRadios = document.querySelectorAll('input[name="payment_method"]');
  const convenienceOptionsContainer = document.getElementById('convenienceOptions');
  const convenienceOptionsInputs = convenienceOptionsContainer.querySelectorAll('input[name="convenience_type"]');

  function toggleConvenienceOptions() {
    const selected = document.querySelector('input[name="payment_method"]:checked');
    if (!selected) return;
    const isConvenience = (selected.value === 'convenience_store');

    convenienceOptionsContainer.style.display = isConvenience ? 'block' : 'none';

    convenienceOptionsInputs.forEach(input => {
      if (isConvenience) {
        input.disabled = false;
      } else {
        input.checked = false;
        input.disabled = true;
      }
    });
  }

  paymentRadios.forEach(radio => {
    radio.addEventListener('change', toggleConvenienceOptions);
  });

  toggleConvenienceOptions();

  // クーポン選択処理
  const couponSelect = document.getElementById('couponSelect');
  if (couponSelect) {
    const totalPrice = {{ total_price }};
    
    couponSelect.addEventListener('change', function() {
      const selected = this.options[this.selectedIndex];
      const discountInfo = document.getElementById('discountInfo');
      const discountText = document.getElementById('discountText');
      const discountRow = document.getElementById('discountRow');
      const discountAmount = document.getElementById('discountAmount');
      const finalTotal = document.getElementById('finalTotal');
      const selectedCouponId = document.getElementById('selectedCouponId');
      
      if (this.value) {
        const type = selected.dataset.type;
        const value = parseFloat(selected.dataset.value);
        let discount = 0;
        let finalPrice = totalPrice;
        
        if (type === 'percentage') {
          discount = Math.floor((totalPrice * value) / 100);
          finalPrice = totalPrice - discount;
          discountText.textContent = `${value}%割引が適用されました！ ¥${discount.toLocaleString()}お得！`;
        } else if (type === 'fixed') {
          discount = value;
          finalPrice = Math.max(0, totalPrice - discount);
          discountText.textContent = `¥${discount.toLocaleString()}割引が適用されました！`;
        } else if (type === 'free') {
          discount = totalPrice;
          finalPrice = 0;
          discountText.textContent = '無料クーポンが適用されました！';
        }
        
        // 表示を更新
        discountInfo.style.display = 'block';
        discountRow.style.display = 'flex';
        discountAmount.textContent = `-¥${discount.toLocaleString()}`;
        finalTotal.textContent = `¥${finalPrice.toLocaleString()}`;
        selectedCouponId.value = this.value;
      } else {
        // クーポン未選択
        discountInfo.style.display = 'none';
        discountRow.style.display = 'none';
        finalTotal.textContent = `¥${totalPrice.toLocaleString()}`;
        selectedCouponId.value = '';
      }
    });
  }
});
</script>

{% endblock %}