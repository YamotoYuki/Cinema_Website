{% extends '_base.html' %}
{% load static %}

{% block title %}購入確認{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/app/purchase_confirm.css' %}">
<style>
.points-display {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: #f8f9fa;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  margin-bottom: 8px;
  font-size: 0.95rem;
}

.points-display-label {
  color: #666;
  font-weight: 500;
}

.points-display-value {
  color: #667eea;
  font-weight: 700;
  font-size: 1.1rem;
}

.payment-option {
  position: relative;
}

.payment-option.disabled {
  opacity: 0.5;
  pointer-events: none;
  background-color: #f5f5f5;
  cursor: not-allowed;
}

.price-breakdown {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 10px;
  margin-top: 20px;
}

.price-breakdown .price-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  font-size: 1rem;
}

.price-breakdown .price-row:last-child {
  border-top: 2px solid #dee2e6;
  margin-top: 10px;
  padding-top: 15px;
  font-weight: bold;
  font-size: 1.2rem;
}
</style>
{% endblock %}

{% block content %}
<div class="div py-5">
  <h2 class="mb-4 text-center">購入内容の確認</h2>

  <div class="card p-4 shadow-sm">
    <h4 style="font-size: 2rem;">{{ movie.title }}</h4>
    <p><strong>上映日時:</strong> {{ selected_datetime }}</p>
    <p><strong>スクリーン:</strong> {{ movie.theater }}</p>
    <p><strong>上映時間:</strong> {{ movie.duration }}分</p>

    <hr>

    <p><strong>選択された座席:</strong> {{ selected_seat_numbers|join:", " }}</p>
    <p><strong>座席数:</strong> {{ selected_seat_count }} 席</p>



    <!-- 料金区分選択セクション -->
    <div class="ticket-type-section">
      <h5 class="mb-3">
        <i class="bi bi-ticket-detailed-fill me-2"></i>
        チケット種別を選択してください
      </h5>
      
      <div class="ticket-type-row">
        <span class="ticket-type-label">一般</span>
        <span class="ticket-type-price">¥1,900</span>
        <div class="ticket-quantity">
          <button type="button" class="quantity-btn" data-type="general" data-action="minus">-</button>
          <span class="quantity-display" id="qty-general">0</span>
          <button type="button" class="quantity-btn" data-type="general" data-action="plus">+</button>
        </div>
      </div>
      
      <div class="ticket-type-row">
        <span class="ticket-type-label">大学生・専門学生</span>
        <span class="ticket-type-price">¥1,500</span>
        <div class="ticket-quantity">
          <button type="button" class="quantity-btn" data-type="student" data-action="minus">-</button>
          <span class="quantity-display" id="qty-student">0</span>
          <button type="button" class="quantity-btn" data-type="student" data-action="plus">+</button>
        </div>
      </div>
      
      <div class="ticket-type-row">
        <span class="ticket-type-label">高校生以下</span>
        <span class="ticket-type-price">¥1,000</span>
        <div class="ticket-quantity">
          <button type="button" class="quantity-btn" data-type="youth" data-action="minus">-</button>
          <span class="quantity-display" id="qty-youth">0</span>
          <button type="button" class="quantity-btn" data-type="youth" data-action="plus">+</button>
        </div>
      </div>
      
      <div class="ticket-type-row">
        <span class="ticket-type-label">シニア（60歳以上）</span>
        <span class="ticket-type-price">¥1,200</span>
        <div class="ticket-quantity">
          <button type="button" class="quantity-btn" data-type="senior" data-action="minus">-</button>
          <span class="quantity-display" id="qty-senior">0</span>
          <button type="button" class="quantity-btn" data-type="senior" data-action="plus">+</button>
        </div>
      </div>
      
      <div class="ticket-type-row">
        <span class="ticket-type-label">障がい者割引</span>
        <span class="ticket-type-price">¥1,000</span>
        <div class="ticket-quantity">
          <button type="button" class="quantity-btn" data-type="disability" data-action="minus">-</button>
          <span class="quantity-display" id="qty-disability">0</span>
          <button type="button" class="quantity-btn" data-type="disability" data-action="plus">+</button>
        </div>
      </div>
      
      <div id="seatMismatchWarning" class="seat-mismatch-warning" style="display: none;">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <strong>注意:</strong> 選択された座席数とチケット枚数が一致していません。
        <div class="mt-2">
          <strong>座席数:</strong> <span id="warningSeatsCount">0</span>席 / 
          <strong>チケット:</strong> <span id="warningTicketsCount">0</span>枚
        </div>
      </div>
    </div>

    <!-- クーポン選択セクション -->
    {% if available_coupons %}
    <div class="coupon-section">
      <h5 class="mb-3">
        <i class="bi bi-ticket-perforated-fill me-2"></i>
        クーポンを使用する（任意）
      </h5>
      <select name="coupon_id" id="couponSelect" class="coupon-select">
        <option value="">クーポンを選択してください</option>
        {% for coupon in available_coupons %}
        <option value="{{ coupon.id }}" 
                data-type="{{ coupon.discount_type }}" 
                data-value="{{ coupon.discount_value }}">
          {{ coupon.title }} - 
          {% if coupon.discount_type == 'percentage' %}
            {{ coupon.discount_value }}%OFF
          {% elif coupon.discount_type == 'fixed' %}
            ¥{{ coupon.discount_value }}OFF
          {% else %}
            無料
          {% endif %}
          (有効期限: {{ coupon.expiry_date|date:"Y/m/d" }})
        </option>
        {% endfor %}
      </select>
      <div id="discountInfo" class="discount-info" style="display: none;">
        <i class="bi bi-check-circle-fill"></i>
        <span id="discountText"></span>
      </div>
    </div>
    {% endif %}

    <!-- 金額表示 -->
    <div class="price-breakdown">
      <div class="price-row" id="priceDetailRow"></div>
      <div class="price-row">
        <span>小計:</span>
        <span id="subtotal">¥0</span>
      </div>
      <div class="price-row" id="discountRow" style="display: none;">
        <span style="color: #dc3545;">
          <i class="bi bi-tag-fill me-1"></i>
          クーポン割引:
        </span>
        <span id="discountAmount" style="color: #dc3545;">-¥0</span>
      </div>
      <div class="price-row" id="pointsPaymentRow" style="display: none;">
        <span style="color: #667eea;">
          <i class="bi bi-coin me-1"></i>
          ポイント使用:
        </span>
        <span id="pointsPaymentAmount" style="color: #667eea;">0 pt</span>
      </div>
      <div class="price-row">
        <span id="totalLabel">合計金額:</span>
        <span id="finalTotal">¥0</span>
      </div>
    </div>

    <!-- ポイント使用セクション（チケット選択後に表示） -->
    <div id="pointsUsageSection" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 2px solid #667eea;">
      <h6 style="color: #667eea; font-weight: 600; margin-bottom: 15px;">
        <i class="bi bi-wallet2 me-2"></i>
        ポイントを使用する（任意）
      </h6>
      
      <!-- 保有ポイント表示 -->
      <div style="background: white; padding: 12px 16px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
        <span style="color: #666; font-size: 0.95rem;">
          <i class="bi bi-coin me-1"></i>
          保有ポイント
        </span>
        <span style="color: #667eea; font-weight: 700; font-size: 1.1rem;">{{ user_points|default:0 }} pt</span>
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 8px; color: #666; font-size: 0.9rem;">
          使用するポイント数を入力してください
        </label>
        <div style="display: flex; align-items: center; gap: 10px;">
          <input type="number" 
                 id="pointsToUse" 
                 min="0" 
                 max="{{ user_points|default:0 }}" 
                 value="0"
                 style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;"
                 placeholder="0">
          <span style="color: #666; font-weight: 600;">pt</span>
          <button type="button" 
                  id="useMaxPointsBtn" 
                  style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; white-space: nowrap; font-size: 0.9rem;">
            最大使用
          </button>
        </div>
        <div style="margin-top: 8px; font-size: 0.85rem; color: #999;">
          <span id="maxPointsText">最大: 0pt まで使用可能</span>
        </div>
      </div>

      <div id="pointsBreakdown" style="background: white; padding: 15px; border-radius: 8px; display: none;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
          <span style="color: #666;">支払い金額:</span>
          <span id="partialTotalAmount" style="font-weight: 600;">¥0</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
          <span style="color: #667eea;">
            <i class="bi bi-coin me-1"></i>
            ポイント使用:
          </span>
          <span id="partialPointsUsed" style="color: #667eea; font-weight: 600;">0 pt (-¥0)</span>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="font-weight: 600; font-size: 1.1rem;">残りのお支払い:</span>
          <span id="partialCashAmount" style="font-weight: 700; font-size: 1.2rem; color: #22c55e;">¥0</span>
        </div>
      </div>
    </div>

    <hr>

    <form method="post" id="purchaseForm">
      {% csrf_token %}
      <input type="hidden" name="movie_id" value="{{ movie.id }}">
      <input type="hidden" name="coupon_id" id="selectedCouponId" value="">
      <input type="hidden" name="ticket_types" id="ticketTypesInput" value="">
      <input type="hidden" name="points_to_use" id="pointsToUseHidden" value="0">
      {% for seat_id in selected_seat_ids %}
        <input type="hidden" name="seats" value="{{ seat_id }}">
      {% endfor %}

      <label class="form-label fw-bold mb-3">決済方法を選択してください</label>

      <label class="payment-option" for="payment_cash">
        <input type="radio" name="payment_method" id="payment_cash" value="cash" checked>
        <img src="{% static 'logo/genkin.png' %}" alt="現金アイコン">
        現金
      </label>

      <label class="payment-option" for="payment_credit">
        <input type="radio" name="payment_method" id="payment_credit" value="credit_card">
        <img src="{% static 'logo/visa.png' %}" alt="クレジットカードアイコン">
        クレジットカード
      </label>

      <label class="payment-option" for="payment_paypal">
        <input type="radio" name="payment_method" id="payment_paypal" value="paypal">
        <img src="{% static 'logo/paypal.png' %}" alt="PayPalアイコン">
        PayPal
      </label>

      <label class="payment-option" for="payment_merpay">
        <input type="radio" name="payment_method" id="payment_merpay" value="merpay">
        <img src="{% static 'logo/merpay.png' %}" alt="メルペイアイコン">
        メルペイ
      </label>

      <label class="payment-option" for="payment_paypay">
        <input type="radio" name="payment_method" id="payment_paypay" value="paypay">
        <img src="{% static 'logo/paypay.png' %}" alt="PayPayアイコン">
        PayPay
      </label>

      <label class="payment-option" for="payment_points" id="pointsPaymentOption">
        <input type="radio" name="payment_method" id="payment_points" value="points">
        <i class="bi bi-coin" style="font-size: 2rem; color: #667eea;"></i>
        <span style="margin-left: 10px;">ポイント払い</span>
        <span style="font-size: 0.85rem; color: #666; margin-left: 10px;">
          (保有: {{ user_points|default:0 }}pt)
        </span>
      </label>

      <label class="payment-option" for="payment_convenience">
        <input type="radio" name="payment_method" id="payment_convenience" value="convenience_store">
        <img src="{% static 'logo/konbini2.jpg' %}" alt="コンビニ払いアイコン">
        コンビニ払い
      </label>

      <div class="convenience-options" id="convenienceOptions">
        <label class="convenience-option" for="conbini_7eleven">
          <input type="radio" name="convenience_type" id="conbini_7eleven" value="7eleven">
          <img src="{% static 'logo/seveneleven.png' %}" alt="セブンイレブンアイコン">
          セブンイレブン
        </label>
        <label class="convenience-option" for="conbini_famima">
          <input type="radio" name="convenience_type" id="conbini_famima" value="famima">
          <img src="{% static 'logo/family-mart.jpeg' %}" alt="ファミリーマートアイコン">
          ファミリーマート
        </label>
        <label class="convenience-option" for="conbini_lawson">
          <input type="radio" name="convenience_type" id="conbini_lawson" value="lawson">
          <img src="{% static 'logo/lawson.jpg' %}" alt="ローソンアイコン">
          ローソン
        </label>
        <label class="convenience-option" for="conbini_daily">
          <input type="radio" name="convenience_type" id="conbini_daily" value="daily">
          <img src="{% static 'logo/daily.jpeg' %}" alt="デイリーヤマザキアイコン">
          デイリーヤマザキ
        </label>
      </div>

      <button type="submit" class="btn btn-success mt-3" id="submitBtn" disabled>購入を確定する</button>
    </form>

    <div class="mt-3">
      <a href="{% url 'seat_select' movie.id %}" class="btn btn-secondary">座席を選び直す</a>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // 料金設定
  const ticketPrices = {
    general: 1900,
    student: 1500,
    youth: 1000,
    senior: 1200,
    disability: 1000
  };
  
  const ticketLabels = {
    general: '一般',
    student: '大学生・専門学生',
    youth: '高校生以下',
    senior: 'シニア',
    disability: '障がい者割引'
  };
  
  const ticketQuantities = {
    general: 0,
    student: 0,
    youth: 0,
    senior: 0,
    disability: 0
  };
  
  const selectedSeatsCount = {{ selected_seat_count }};
  const userPoints = {{ user_points|default:0 }};
  
  // 数量ボタンの処理
  document.querySelectorAll('.quantity-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const type = this.dataset.type;
      const action = this.dataset.action;
      const display = document.getElementById(`qty-${type}`);
      
      if (action === 'plus') {
        const total = Object.values(ticketQuantities).reduce((a, b) => a + b, 0);
        if (total < selectedSeatsCount) {
          ticketQuantities[type]++;
        }
      } else if (action === 'minus' && ticketQuantities[type] > 0) {
        ticketQuantities[type]--;
      }
      
      display.textContent = ticketQuantities[type];
      updatePriceDisplay();
      checkSeatMatch();
      updatePointsUsageSection();
    });
  });
  
  function updatePriceDisplay() {
    let subtotal = 0;
    let detailHTML = '';
    
    for (const [type, qty] of Object.entries(ticketQuantities)) {
      if (qty > 0) {
        const price = ticketPrices[type] * qty;
        subtotal += price;
        detailHTML += `<div style="display: flex; justify-content: space-between; padding: 4px 0;">
          <span>${ticketLabels[type]} × ${qty}</span>
          <span>¥${price.toLocaleString()}</span>
        </div>`;
      }
    }
    
    document.getElementById('priceDetailRow').innerHTML = detailHTML;
    document.getElementById('subtotal').textContent = `¥${subtotal.toLocaleString()}`;
    
    // クーポン適用を再計算
    applyCouponDiscount(subtotal);
    
    // Hidden inputに保存
    document.getElementById('ticketTypesInput').value = JSON.stringify(ticketQuantities);
  }
  
  function checkSeatMatch() {
    const totalTickets = Object.values(ticketQuantities).reduce((a, b) => a + b, 0);
    const warning = document.getElementById('seatMismatchWarning');
    const submitBtn = document.getElementById('submitBtn');
    
    document.getElementById('warningSeatsCount').textContent = selectedSeatsCount;
    document.getElementById('warningTicketsCount').textContent = totalTickets;
    
    // チケット未選択または不一致の場合
    if (totalTickets === 0 || totalTickets !== selectedSeatsCount) {
      if (totalTickets > 0) {
        warning.style.display = 'block';
      } else {
        warning.style.display = 'none';
      }
      submitBtn.disabled = true;
      return;
    }
    
    // チケット数と座席数が一致している場合
    warning.style.display = 'none';
    submitBtn.disabled = false;
  }
  
  function updatePointsUsageSection() {
    const totalTickets = Object.values(ticketQuantities).reduce((a, b) => a + b, 0);
    const pointsUsageSection = document.getElementById('pointsUsageSection');
    const pointsPaymentOption = document.getElementById('pointsPaymentOption');
    const pointsPaymentRadio = document.getElementById('payment_points');
    
    // チケットが選択され、座席数と一致している場合のみポイント使用セクションを表示
    if (totalTickets > 0 && totalTickets === selectedSeatsCount) {
      pointsUsageSection.style.display = 'block';
      
      // ポイント払いオプションを有効化
      if (pointsPaymentOption && pointsPaymentRadio) {
        pointsPaymentOption.classList.remove('disabled');
        pointsPaymentRadio.disabled = false;
      }
      
      // 現在の合計金額を取得
      const subtotalText = document.getElementById('subtotal').textContent.replace(/[¥,]/g, '');
      const subtotal = parseFloat(subtotalText) || 0;
      
      const discountRow = document.getElementById('discountRow');
      const isDiscountApplied = discountRow.style.display === 'flex';
      
      let currentTotal = subtotal;
      if (isDiscountApplied) {
        const discountText = document.getElementById('discountAmount').textContent.replace(/[-¥,]/g, '');
        const discount = parseFloat(discountText) || 0;
        currentTotal = subtotal - discount;
      }
      
      // 使用可能な最大ポイントを計算
      const maxUsablePoints = Math.min(Math.floor(currentTotal), userPoints);
      
      // 最大ポイントテキストを更新
      document.getElementById('maxPointsText').textContent = `最大: ${maxUsablePoints}pt まで使用可能`;
      
      // ポイント入力フィールドのmaxを更新
      const pointsToUseInput = document.getElementById('pointsToUse');
      pointsToUseInput.max = maxUsablePoints;
      
      // 現在の入力値が最大値を超えている場合は調整
      if (parseInt(pointsToUseInput.value) > maxUsablePoints) {
        pointsToUseInput.value = maxUsablePoints;
        updatePartialPaymentDisplay();
      }
    } else {
      pointsUsageSection.style.display = 'none';
      
      // ポイント払いオプションを無効化
      if (pointsPaymentOption && pointsPaymentRadio) {
        pointsPaymentOption.classList.add('disabled');
        pointsPaymentRadio.disabled = true;
        
        // もしポイント払いが選択されていたら現金に戻す
        if (pointsPaymentRadio.checked) {
          pointsPaymentRadio.checked = false;
          document.getElementById('payment_cash').checked = true;
          toggleConvenienceOptions();
        }
      }
      
      // ポイント入力をリセット
      document.getElementById('pointsToUse').value = 0;
      updatePartialPaymentDisplay();
    }
  }
  
  // クーポン処理
  const couponSelect = document.getElementById('couponSelect');
  if (couponSelect) {
    couponSelect.addEventListener('change', function() {
      const subtotalText = document.getElementById('subtotal').textContent.replace(/[¥,]/g, '');
      const subtotal = parseFloat(subtotalText);
      applyCouponDiscount(subtotal);
      updatePointsUsageSection();
    });
  }
  
  function applyCouponDiscount(subtotal) {
    const couponSelect = document.getElementById('couponSelect');
    if (!couponSelect) return;
    
    const selected = couponSelect.options[couponSelect.selectedIndex];
    const discountInfo = document.getElementById('discountInfo');
    const discountText = document.getElementById('discountText');
    const discountRow = document.getElementById('discountRow');
    const discountAmount = document.getElementById('discountAmount');
    const finalTotal = document.getElementById('finalTotal');
    const selectedCouponId = document.getElementById('selectedCouponId');
    
    let finalPrice = subtotal;
    
    if (couponSelect.value && subtotal > 0) {
      const type = selected.dataset.type;
      const value = parseFloat(selected.dataset.value);
      let discount = 0;
      
      if (type === 'percentage') {
        discount = Math.floor((subtotal * value) / 100);
        finalPrice = subtotal - discount;
        discountText.textContent = `${value}%割引が適用されました！ ¥${discount.toLocaleString()}お得！`;
      } else if (type === 'fixed') {
        discount = value;
        finalPrice = Math.max(0, subtotal - discount);
        discountText.textContent = `¥${discount.toLocaleString()}割引が適用されました！`;
      } else if (type === 'free') {
        discount = subtotal;
        finalPrice = 0;
        discountText.textContent = '無料クーポンが適用されました！';
      }
      
      discountInfo.style.display = 'block';
      discountRow.style.display = 'flex';
      discountAmount.textContent = `-¥${discount.toLocaleString()}`;
      selectedCouponId.value = couponSelect.value;
    } else {
      discountInfo.style.display = 'none';
      discountRow.style.display = 'none';
      selectedCouponId.value = '';
    }
    
    // ポイント使用を反映
    updateFinalTotalDisplay(finalPrice);
  }
  
  function updateFinalTotalDisplay(basePrice) {
    const pointsUsed = parseInt(document.getElementById('pointsToUse').value) || 0;
    const finalTotal = document.getElementById('finalTotal');
    const totalLabel = document.getElementById('totalLabel');
    const pointsPaymentRow = document.getElementById('pointsPaymentRow');
    const pointsPaymentAmount = document.getElementById('pointsPaymentAmount');
    
    if (pointsUsed > 0) {
      const cashAmount = Math.max(0, basePrice - pointsUsed);
      
      pointsPaymentRow.style.display = 'flex';
      pointsPaymentAmount.textContent = `${pointsUsed} pt`;
      
      if (cashAmount > 0) {
        totalLabel.textContent = 'お支払い金額:';
        finalTotal.textContent = `¥${Math.floor(cashAmount).toLocaleString()}`;
        finalTotal.style.color = '#22c55e';
      } else {
        totalLabel.textContent = 'お支払い金額:';
        finalTotal.textContent = '¥0';
        finalTotal.style.color = '#22c55e';
      }
    } else {
      pointsPaymentRow.style.display = 'none';
      totalLabel.textContent = '合計金額:';
      finalTotal.textContent = `¥${Math.floor(basePrice).toLocaleString()}`;
      finalTotal.style.color = '';
    }
  }
  
  // ポイント入力の処理（hidden inputも更新）
  const pointsToUseInput = document.getElementById('pointsToUse');
  const pointsToUseHidden = document.getElementById('pointsToUseHidden');
  
  if (pointsToUseInput) {
    pointsToUseInput.addEventListener('input', function() {
      const pointsUsed = parseInt(this.value) || 0;
      const maxPoints = parseInt(this.max);
      
      // 最大値を超えないように制限
      if (pointsUsed > maxPoints) {
        this.value = maxPoints;
      }
      
      // 負の値を許可しない
      if (pointsUsed < 0) {
        this.value = 0;
      }
      
      // hidden inputも更新
      pointsToUseHidden.value = this.value;
      
      updatePartialPaymentDisplay();
    });
  }

  // 最大使用ボタンの処理
  const useMaxPointsBtn = document.getElementById('useMaxPointsBtn');
  if (useMaxPointsBtn) {
    useMaxPointsBtn.addEventListener('click', function() {
      const maxUsable = parseInt(pointsToUseInput.max) || 0;
      pointsToUseInput.value = maxUsable;
      // hidden inputも更新
      pointsToUseHidden.value = maxUsable;
      updatePartialPaymentDisplay();
    });
  }

  function updatePartialPaymentDisplay() {
    const pointsUsed = parseInt(pointsToUseInput.value) || 0;
    
    // 現在の合計金額を取得
    const subtotalText = document.getElementById('subtotal').textContent.replace(/[¥,]/g, '');
    const subtotal = parseFloat(subtotalText) || 0;
    
    const discountRow = document.getElementById('discountRow');
    const isDiscountApplied = discountRow.style.display === 'flex';
    
    let currentTotal = subtotal;
    if (isDiscountApplied) {
      const discountText = document.getElementById('discountAmount').textContent.replace(/[-¥,]/g, '');
      const discount = parseFloat(discountText) || 0;
      currentTotal = subtotal - discount;
    }
    
    const cashAmount = Math.max(0, currentTotal - pointsUsed);
    const pointsBreakdown = document.getElementById('pointsBreakdown');
    
    // 内訳を表示
    if (pointsUsed > 0) {
      pointsBreakdown.style.display = 'block';
      document.getElementById('partialTotalAmount').textContent = `¥${Math.floor(currentTotal).toLocaleString()}`;
      document.getElementById('partialPointsUsed').textContent = `${pointsUsed} pt (-¥${pointsUsed.toLocaleString()})`;
      document.getElementById('partialCashAmount').textContent = `¥${Math.floor(cashAmount).toLocaleString()}`;
    } else {
      pointsBreakdown.style.display = 'none';
    }
    
    // 合計金額表示を更新
    updateFinalTotalDisplay(currentTotal);
  }

  // 支払い方法の処理
  const paymentRadios = document.querySelectorAll('input[name="payment_method"]');
  const convenienceOptionsContainer = document.getElementById('convenienceOptions');
  const convenienceOptionsInputs = convenienceOptionsContainer.querySelectorAll('input[name="convenience_type"]');

  function toggleConvenienceOptions() {
    const selected = document.querySelector('input[name="payment_method"]:checked');
    if (!selected) return;
    const isConvenience = (selected.value === 'convenience_store');
    const isPoints = (selected.value === 'points');

    convenienceOptionsContainer.style.display = isConvenience ? 'block' : 'none';

    convenienceOptionsInputs.forEach(input => {
      if (isConvenience) {
        input.disabled = false;
      } else {
        input.checked = false;
        input.disabled = true;
      }
    });
    
    // ポイント払い選択時の処理
    if (isPoints) {
      // ポイント使用セクションが表示されている場合、最大ポイントを自動設定
      const pointsUsageSection = document.getElementById('pointsUsageSection');
      if (pointsUsageSection.style.display === 'block') {
        const maxUsable = parseInt(pointsToUseInput.max) || 0;
        pointsToUseInput.value = maxUsable;
        // hidden inputも更新
        pointsToUseHidden.value = maxUsable;
        updatePartialPaymentDisplay();
      }
    }
  }

  paymentRadios.forEach(radio => {
    radio.addEventListener('change', toggleConvenienceOptions);
  });

  // 初期状態でポイント払いを無効化
  const pointsPaymentOption = document.getElementById('pointsPaymentOption');
  const pointsPaymentRadio = document.getElementById('payment_points');
  if (pointsPaymentOption && pointsPaymentRadio) {
    pointsPaymentOption.classList.add('disabled');
    pointsPaymentRadio.disabled = true;
  }

  toggleConvenienceOptions();
  checkSeatMatch();

  // ===================================================
  // ★★★ 追加: フォーム送信直前にcoupon_idを確実にセット ★★★
  // ===================================================
  document.getElementById('purchaseForm').addEventListener('submit', function() {
    const couponSelect = document.getElementById('couponSelect');
    if (couponSelect) {
      document.getElementById('selectedCouponId').value = couponSelect.value;
    }
    document.getElementById('pointsToUseHidden').value =
      document.getElementById('pointsToUse').value || 0;
  });

});
</script>

{% endblock %}