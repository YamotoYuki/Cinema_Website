{% extends '_base.html' %}
{% load static %}

{% block title %}購入確認{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/app/purchase_confirm.css' %}">
{% endblock %}

{% block content %}
<div class="div py-5">
  <h2 class="mb-4 text-center">購入内容の確認</h2>

  <div class="card p-4 shadow-sm">
    <h4 style="font-size: 2rem;">{{ movie.title }}</h4>
    <p><strong>上映日時:</strong> {{ selected_datetime }}</p>
    <p><strong>スクリーン:</strong> {{ movie.theater }}</p>
    <p><strong>上映時間:</strong> {{ movie.duration }}分</p>

    <hr>

    <p><strong>選択された座席:</strong> {{ selected_seat_numbers|join:", " }}</p>
    <p><strong>座席数:</strong> {{ selected_seat_count }} 席</p>

    <!-- 料金区分選択セクション -->
    <div class="ticket-type-section">
      <h5 class="mb-3">
        <i class="bi bi-ticket-detailed-fill me-2"></i>
        チケット種別を選択してください
      </h5>
      
      <div class="ticket-type-row">
        <span class="ticket-type-label">一般</span>
        <span class="ticket-type-price">¥1,900</span>
        <div class="ticket-quantity">
          <button type="button" class="quantity-btn" data-type="general" data-action="minus">-</button>
          <span class="quantity-display" id="qty-general">0</span>
          <button type="button" class="quantity-btn" data-type="general" data-action="plus">+</button>
        </div>
      </div>
      
      <div class="ticket-type-row">
        <span class="ticket-type-label">大学生・専門学生</span>
        <span class="ticket-type-price">¥1,500</span>
        <div class="ticket-quantity">
          <button type="button" class="quantity-btn" data-type="student" data-action="minus">-</button>
          <span class="quantity-display" id="qty-student">0</span>
          <button type="button" class="quantity-btn" data-type="student" data-action="plus">+</button>
        </div>
      </div>
      
      <div class="ticket-type-row">
        <span class="ticket-type-label">高校生以下</span>
        <span class="ticket-type-price">¥1,000</span>
        <div class="ticket-quantity">
          <button type="button" class="quantity-btn" data-type="youth" data-action="minus">-</button>
          <span class="quantity-display" id="qty-youth">0</span>
          <button type="button" class="quantity-btn" data-type="youth" data-action="plus">+</button>
        </div>
      </div>
      
      <div class="ticket-type-row">
        <span class="ticket-type-label">シニア（60歳以上）</span>
        <span class="ticket-type-price">¥1,200</span>
        <div class="ticket-quantity">
          <button type="button" class="quantity-btn" data-type="senior" data-action="minus">-</button>
          <span class="quantity-display" id="qty-senior">0</span>
          <button type="button" class="quantity-btn" data-type="senior" data-action="plus">+</button>
        </div>
      </div>
      
      <div class="ticket-type-row">
        <span class="ticket-type-label">障がい者割引</span>
        <span class="ticket-type-price">¥1,000</span>
        <div class="ticket-quantity">
          <button type="button" class="quantity-btn" data-type="disability" data-action="minus">-</button>
          <span class="quantity-display" id="qty-disability">0</span>
          <button type="button" class="quantity-btn" data-type="disability" data-action="plus">+</button>
        </div>
      </div>
      
      <div id="seatMismatchWarning" class="seat-mismatch-warning" style="display: none;">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <strong>注意:</strong> 選択された座席数とチケット枚数が一致していません。
        <div class="mt-2">
          <strong>座席数:</strong> <span id="warningSeatsCount">0</span>席 / 
          <strong>チケット:</strong> <span id="warningTicketsCount">0</span>枚
        </div>
      </div>
    </div>

    <!-- クーポン選択セクション -->
    {% if available_coupons %}
    <div class="coupon-section">
      <h5 class="mb-3">
        <i class="bi bi-ticket-perforated-fill me-2"></i>
        クーポンを使用する（任意）
      </h5>
      <select name="coupon_id" id="couponSelect" class="coupon-select">
        <option value="">クーポンを選択してください</option>
        {% for coupon in available_coupons %}
        <option value="{{ coupon.id }}" 
                data-type="{{ coupon.discount_type }}" 
                data-value="{{ coupon.discount_value }}">
          {{ coupon.title }} - 
          {% if coupon.discount_type == 'percentage' %}
            {{ coupon.discount_value }}%OFF
          {% elif coupon.discount_type == 'fixed' %}
            ¥{{ coupon.discount_value }}OFF
          {% else %}
            無料
          {% endif %}
          (有効期限: {{ coupon.expiry_date|date:"Y/m/d" }})
        </option>
        {% endfor %}
      </select>
      <div id="discountInfo" class="discount-info" style="display: none;">
        <i class="bi bi-check-circle-fill"></i>
        <span id="discountText"></span>
      </div>
    </div>
    {% endif %}

    <!-- 金額表示 -->
    <div class="price-breakdown">
      <div class="price-row" id="priceDetailRow"></div>
      <div class="price-row">
        <span>小計:</span>
        <span id="subtotal">¥0</span>
      </div>
      <div class="price-row" id="discountRow" style="display: none;">
        <span style="color: #dc3545;">
          <i class="bi bi-tag-fill me-1"></i>
          クーポン割引:
        </span>
        <span id="discountAmount" style="color: #dc3545;">-¥0</span>
      </div>
      <div class="price-row">
        <span>合計金額:</span>
        <span id="finalTotal">¥0</span>
      </div>
    </div>

    <hr>

    <form method="post" id="purchaseForm">
      {% csrf_token %}
      <input type="hidden" name="movie_id" value="{{ movie.id }}">
      <input type="hidden" name="coupon_id" id="selectedCouponId" value="">
      <input type="hidden" name="ticket_types" id="ticketTypesInput" value="">
      {% for seat_id in selected_seat_ids %}
        <input type="hidden" name="seats" value="{{ seat_id }}">
      {% endfor %}

      <label class="form-label fw-bold mb-3">決済方法を選択してください</label>

      <label class="payment-option" for="payment_cash">
        <input type="radio" name="payment_method" id="payment_cash" value="cash" checked>
        <img src="{% static 'logo/genkin.png' %}" alt="現金アイコン">
        現金
      </label>

      <label class="payment-option" for="payment_credit">
        <input type="radio" name="payment_method" id="payment_credit" value="credit_card">
        <img src="{% static 'logo/visa.png' %}" alt="クレジットカードアイコン">
        クレジットカード
      </label>

      <label class="payment-option" for="payment_paypal">
        <input type="radio" name="payment_method" id="payment_paypal" value="paypal">
        <img src="{% static 'logo/paypal.png' %}" alt="PayPalアイコン">
        PayPal
      </label>

      <label class="payment-option" for="payment_merpay">
        <input type="radio" name="payment_method" id="payment_merpay" value="merpay">
        <img src="{% static 'logo/merpay.png' %}" alt="メルペイアイコン">
        メルペイ
      </label>

      <label class="payment-option" for="payment_paypay">
        <input type="radio" name="payment_method" id="payment_paypay" value="paypay">
        <img src="{% static 'logo/paypay.png' %}" alt="PayPayアイコン">
        PayPay
      </label>

      <label class="payment-option" for="payment_convenience">
        <input type="radio" name="payment_method" id="payment_convenience" value="convenience_store">
        <img src="{% static 'logo/konbini2.jpg' %}" alt="コンビニ払いアイコン">
        コンビニ払い
      </label>

      <div class="convenience-options" id="convenienceOptions">
        <label class="convenience-option" for="conbini_7eleven">
          <input type="radio" name="convenience_type" id="conbini_7eleven" value="7eleven">
          <img src="{% static 'logo/seveneleven.png' %}" alt="セブンイレブンアイコン">
          セブンイレブン
        </label>
        <label class="convenience-option" for="conbini_famima">
          <input type="radio" name="convenience_type" id="conbini_famima" value="famima">
          <img src="{% static 'logo/family-mart.jpeg' %}" alt="ファミリーマートアイコン">
          ファミリーマート
        </label>
        <label class="convenience-option" for="conbini_lawson">
          <input type="radio" name="convenience_type" id="conbini_lawson" value="lawson">
          <img src="{% static 'logo/lawson.jpg' %}" alt="ローソンアイコン">
          ローソン
        </label>
        <label class="convenience-option" for="conbini_daily">
          <input type="radio" name="convenience_type" id="conbini_daily" value="daily">
          <img src="{% static 'logo/daily.jpeg' %}" alt="デイリーヤマザキアイコン">
          デイリーヤマザキ
        </label>
      </div>

      <button type="submit" class="btn btn-success mt-3" id="submitBtn" disabled>購入を確定する</button>
    </form>

    <div class="mt-3">
      <a href="{% url 'seat_select' movie.id %}" class="btn btn-secondary">座席を選び直す</a>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // 料金設定
  const ticketPrices = {
    general: 1900,
    student: 1500,
    youth: 1000,
    senior: 1200,
    disability: 1000
  };
  
  const ticketLabels = {
    general: '一般',
    student: '大学生・専門学生',
    youth: '高校生以下',
    senior: 'シニア',
    disability: '障がい者割引'
  };
  
  const ticketQuantities = {
    general: 0,
    student: 0,
    youth: 0,
    senior: 0,
    disability: 0
  };
  
  const selectedSeatsCount = {{ selected_seat_count }};
  
  // 数量ボタンの処理
  document.querySelectorAll('.quantity-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const type = this.dataset.type;
      const action = this.dataset.action;
      const display = document.getElementById(`qty-${type}`);
      
      if (action === 'plus') {
        const total = Object.values(ticketQuantities).reduce((a, b) => a + b, 0);
        if (total < selectedSeatsCount) {
          ticketQuantities[type]++;
        }
      } else if (action === 'minus' && ticketQuantities[type] > 0) {
        ticketQuantities[type]--;
      }
      
      display.textContent = ticketQuantities[type];
      updatePriceDisplay();
      checkSeatMatch();
    });
  });
  
  function updatePriceDisplay() {
    let subtotal = 0;
    let detailHTML = '';
    
    for (const [type, qty] of Object.entries(ticketQuantities)) {
      if (qty > 0) {
        const price = ticketPrices[type] * qty;
        subtotal += price;
        detailHTML += `<div style="display: flex; justify-content: space-between; padding: 4px 0;">
          <span>${ticketLabels[type]} × ${qty}</span>
          <span>¥${price.toLocaleString()}</span>
        </div>`;
      }
    }
    
    document.getElementById('priceDetailRow').innerHTML = detailHTML;
    document.getElementById('subtotal').textContent = `¥${subtotal.toLocaleString()}`;
    
    // クーポン適用を再計算
    applyCouponDiscount(subtotal);
    
    // Hidden inputに保存
    document.getElementById('ticketTypesInput').value = JSON.stringify(ticketQuantities);
  }
  
  function checkSeatMatch() {
    const totalTickets = Object.values(ticketQuantities).reduce((a, b) => a + b, 0);
    const warning = document.getElementById('seatMismatchWarning');
    const submitBtn = document.getElementById('submitBtn');
    
    document.getElementById('warningSeatsCount').textContent = selectedSeatsCount;
    document.getElementById('warningTicketsCount').textContent = totalTickets;
    
    if (totalTickets !== selectedSeatsCount) {
      warning.style.display = 'block';
      submitBtn.disabled = true;
    } else {
      warning.style.display = 'none';
      submitBtn.disabled = false;
    }
  }
  
  // クーポン処理
  const couponSelect = document.getElementById('couponSelect');
  if (couponSelect) {
    couponSelect.addEventListener('change', function() {
      const subtotalText = document.getElementById('subtotal').textContent.replace(/[¥,]/g, '');
      const subtotal = parseFloat(subtotalText);
      applyCouponDiscount(subtotal);
    });
  }
  
  function applyCouponDiscount(subtotal) {
    const couponSelect = document.getElementById('couponSelect');
    if (!couponSelect) return;
    
    const selected = couponSelect.options[couponSelect.selectedIndex];
    const discountInfo = document.getElementById('discountInfo');
    const discountText = document.getElementById('discountText');
    const discountRow = document.getElementById('discountRow');
    const discountAmount = document.getElementById('discountAmount');
    const finalTotal = document.getElementById('finalTotal');
    const selectedCouponId = document.getElementById('selectedCouponId');
    
    if (couponSelect.value && subtotal > 0) {
      const type = selected.dataset.type;
      const value = parseFloat(selected.dataset.value);
      let discount = 0;
      let finalPrice = subtotal;
      
      if (type === 'percentage') {
        discount = Math.floor((subtotal * value) / 100);
        finalPrice = subtotal - discount;
        discountText.textContent = `${value}%割引が適用されました！ ¥${discount.toLocaleString()}お得！`;
      } else if (type === 'fixed') {
        discount = value;
        finalPrice = Math.max(0, subtotal - discount);
        discountText.textContent = `¥${discount.toLocaleString()}割引が適用されました！`;
      } else if (type === 'free') {
        discount = subtotal;
        finalPrice = 0;
        discountText.textContent = '無料クーポンが適用されました！';
      }
      
      discountInfo.style.display = 'block';
      discountRow.style.display = 'flex';
      discountAmount.textContent = `-¥${discount.toLocaleString()}`;
      finalTotal.textContent = `¥${finalPrice.toLocaleString()}`;
      selectedCouponId.value = couponSelect.value;
    } else {
      discountInfo.style.display = 'none';
      discountRow.style.display = 'none';
      finalTotal.textContent = `¥${subtotal.toLocaleString()}`;
      selectedCouponId.value = '';
    }
  }
  
  // 支払い方法の処理
  const paymentRadios = document.querySelectorAll('input[name="payment_method"]');
  const convenienceOptionsContainer = document.getElementById('convenienceOptions');
  const convenienceOptionsInputs = convenienceOptionsContainer.querySelectorAll('input[name="convenience_type"]');

  function toggleConvenienceOptions() {
    const selected = document.querySelector('input[name="payment_method"]:checked');
    if (!selected) return;
    const isConvenience = (selected.value === 'convenience_store');

    convenienceOptionsContainer.style.display = isConvenience ? 'block' : 'none';

    convenienceOptionsInputs.forEach(input => {
      if (isConvenience) {
        input.disabled = false;
      } else {
        input.checked = false;
        input.disabled = true;
      }
    });
  }

  paymentRadios.forEach(radio => {
    radio.addEventListener('change', toggleConvenienceOptions);
  });

  toggleConvenienceOptions();
  checkSeatMatch();
});
</script>

{% endblock %}