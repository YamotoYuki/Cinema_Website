{% extends '_base.html' %}
{% load static %}
{% block title %}購入完了{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/app/purchase_complete.css' %}">
{% endblock %}

{% block content %}
<div class="completion-wrapper">
  <div class="completion-card">
    <div class="text-center">
      <div class="success-icon">
        <i class="bi bi-check-circle-fill"></i>
      </div>
      
      <h2 class="completion-title">
        購入が完了しました！
      </h2>
      
      <p class="completion-subtitle">
        ご購入ありがとうございます
      </p>
    </div>
    
    <!-- チケット情報サマリー -->
    <div class="ticket-summary">
      <div class="summary-row">
        <span class="summary-label">
          <i class="bi bi-film me-2"></i>映画
        </span>
        <span class="summary-value">{{ movie.title }}</span>
      </div>
      
      {% if reservation %}
      <div class="summary-row">
        <span class="summary-label">
          <i class="bi bi-calendar-event me-2"></i>上映日時
        </span>
        <span class="summary-value">{{ reservation.show_time }}</span>
      </div>
      
      <div class="summary-row">
        <span class="summary-label">
          <i class="bi bi-geo-alt-fill me-2"></i>スクリーン
        </span>
        <span class="summary-value">{{ movie.theater|default:"Screen 1" }}</span>
      </div>
      {% endif %}
      
      <div class="summary-row">
        <span class="summary-label">
          <i class="bi bi-ticket-perforated me-2"></i>座席
        </span>
        <span class="summary-value">{{ selected_seat_numbers|join:", " }}</span>
      </div>
      
      <!-- 料金詳細 -->
      <div class="price-detail">
        {% if reservation.applied_coupon and reservation.discount_amount > 0 %}
          <div class="price-row">
            <span>元の金額:</span>
            <span class="original-price-text">¥{{ reservation.original_price|floatformat:"0" }}</span>
          </div>
          
          <div class="price-row discount-row">
            <span>
              <i class="bi bi-tag-fill me-1"></i>
              クーポン割引 ({{ reservation.applied_coupon.title }}):
            </span>
            <span>-¥{{ reservation.discount_amount|floatformat:"0" }}</span>
          </div>
          
          <div class="price-row final-price-row">
            <span>お支払い金額:</span>
            <span>¥{{ reservation.final_price|floatformat:"0" }}</span>
          </div>
          
          <div class="text-center mt-3">
            <span class="coupon-badge">
              <i class="bi bi-check-circle-fill me-1"></i>
              クーポンが適用されました
            </span>
          </div>
        {% else %}
          <div class="price-row final-price-row">
            <span>合計金額:</span>
            <span>¥{{ total_price|floatformat:"0" }}</span>
          </div>
        {% endif %}
      </div>
    </div>
    
    <!-- ダウンロードボタン -->
    {% if reservation %}
    <div class="download-section">
      <a href="{% url 'download_ticket_pdf' reservation.id %}" 
         class="download-btn download-btn-ticket" 
         download>
        <i class="bi bi-ticket-detailed-fill" style="font-size: 1.3rem;"></i>
        <span>チケットをダウンロード</span>
      </a>
      
      <a href="{% url 'download_receipt_pdf' reservation.id %}" 
         class="download-btn download-btn-receipt" 
         download>
        <i class="bi bi-receipt" style="font-size: 1.3rem;"></i>
        <span>領収書をダウンロード</span>
      </a>
    </div>
    {% else %}
    <div class="alert alert-warning mt-3">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      予約情報の取得中にエラーが発生しました。マイページの予約一覧からダウンロードできます。
    </div>
    {% endif %}
    
    <!-- アクションボタン -->
    <div class="action-buttons">
      <a href="{% url 'my_reservations' %}" class="action-btn action-btn-primary">
        <i class="bi bi-list-ul me-2"></i>
        予約一覧を見る
      </a>
      
      <a href="{% url 'movie_list' %}" class="action-btn">
        <i class="bi bi-arrow-left me-2"></i>
        映画一覧に戻る
      </a>
    </div>
    
    <!-- 注意事項 -->
    <div style="margin-top: 25px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px; font-size: 0.9rem;">
      <div style="font-weight: 600; margin-bottom: 8px;">
        <i class="bi bi-info-circle-fill me-2"></i>ご注意
      </div>
      <ul style="margin: 0; padding-left: 20px; opacity: 0.9;">
        <li>チケットはPDF形式でダウンロードできます</li>
        <li>入場時にチケットのQRコードをご提示ください</li>
        <li>上映開始の15分前までにご来場ください</li>
      </ul>
    </div>
  </div>
</div>
{% endblock %}