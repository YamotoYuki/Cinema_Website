{% extends '_base.html' %}
{% load static %}

{% block title %}{{ movie.title }}｜チケット購入{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/app/purchase.css' %}">
  <style>
    .favorite-btn {
      border: 2px solid #ffcc00;
      background-color: transparent;
      color: #ffcc00;
      padding: 8px 20px;
      border-radius: 6px;
      font-weight: 600;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .favorite-btn:hover {
      background-color: #ffcc00;
      color: #135034;
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(255, 204, 0, 0.4);
    }
    
    .favorite-btn.active {
      background-color: #ffcc00;
      color: #135034;
    }
    
    .favorite-btn i {
      margin-right: 5px;
      transition: transform 0.3s ease;
    }
    
    .favorite-btn.active i {
      animation: heartBeat 0.6s ease;
    }
    
    @keyframes heartBeat {
      0%, 100% { transform: scale(1); }
      25% { transform: scale(1.3); }
      50% { transform: scale(1.1); }
      75% { transform: scale(1.2); }
    }
  </style>
{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row g-4">
    <div class="col-md-4 text-center">
      {% if movie.image %}
        <img src="{{ movie.image.url }}" class="img-fluid rounded shadow-sm" alt="{{ movie.title }}">
      {% else %}
        <img src="{% static 'images/noimage.jpg' %}" class="img-fluid rounded shadow-sm" alt="画像なし">
      {% endif %}
    </div>

    <div class="col-md-8">
      <div class="d-flex justify-content-between align-items-start mb-3">
        <h2 class="seat-title mb-0">{{ movie.title }}</h2>
        <button class="favorite-btn" id="favoriteBtn" data-movie-id="{{ movie.id }}">
          <i class="bi bi-heart"></i>
          <span class="favorite-text">お気に入り</span>
        </button>
      </div>
      
      <p><strong>ジャンル:</strong> {{ movie.genre }}</p>
      <p><strong>上映時間:</strong> {{ movie.duration }}分</p>
      <p><strong>金額:</strong> ¥{{ movie.price|floatformat:"0" }}</p>

      <div class="mt-4">
        <form method="get" action="{% url 'seat_select' movie.id %}">
          <p class="fw-bold">上映日を選択してください：</p>
          <div class="btn-group flex-wrap" role="group">
            {% for show in show_dates %}
              <input type="radio" class="btn-check" name="date" id="date{{ forloop.counter }}" value="{{ show.date }}" data-weekday="{{ show.weekday }}" {% if forloop.first %}checked{% endif %}>
              <label class="btn btn-outline-primary m-1" for="date{{ forloop.counter }}">{{ show.label }}</label>
            {% endfor %}
          </div>

          <div class="mt-4">
            <p class="fw-bold">上映時間を選択してください：</p>
            <div id="time-slot-container" class="d-flex flex-wrap gap-2">
              {% for time in time_slots %}
                <input type="radio" class="btn-check" name="time_slot" id="time{{ forloop.counter }}" value="{{ time }}" {% if forloop.first %}checked{% endif %}>
                <label class="btn btn-outline-secondary time-label" for="time{{ forloop.counter }}" data-time="{{ time }}">{{ time }}</label>
              {% endfor %}
            </div>
          </div>

          <button type="submit" class="btn btn-success mt-4 px-4">座席を選択する</button>
        </form>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block javascript %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
  crossorigin="anonymous"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const now = new Date();

  function getSelectedDate() {
    const selected = document.querySelector('input[name="date"]:checked');
    return selected ? selected.value : null;
  }

  function disablePastTimeSlots() {
    const selectedDate = getSelectedDate();
    if (!selectedDate) return;

    const todayStr = now.toISOString().split('T')[0]; 
    const isToday = selectedDate === todayStr;

    document.querySelectorAll('.time-label').forEach(label => {
      const time = label.dataset.time;
      const input = document.getElementById(label.htmlFor);

      label.classList.remove('btn-danger');
      label.classList.add('btn-outline-secondary');
      input.disabled = false;

      if (isToday) {
        const [hour, minute] = time.split(':');
        const slotTime = new Date();
        slotTime.setHours(parseInt(hour), parseInt(minute), 0, 0);

        if (slotTime < now) {
          input.disabled = true;
          label.classList.remove('btn-outline-secondary');
          label.classList.add('btn-danger');
        }
      }
    });
  }

  disablePastTimeSlots();
  document.querySelectorAll('input[name="date"]').forEach(radio => {
    radio.addEventListener('change', disablePastTimeSlots);
  });

  // お気に入り機能
  const favoriteBtn = document.getElementById('favoriteBtn');
  const movieId = favoriteBtn.dataset.movieId;
  
  // ローカルストレージから状態を読み込み
  function loadFavoriteState() {
    const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    return favorites.includes(movieId);
  }
  
  // 初期状態を設定
  if (loadFavoriteState()) {
    favoriteBtn.classList.add('active');
    favoriteBtn.querySelector('i').classList.remove('bi-heart');
    favoriteBtn.querySelector('i').classList.add('bi-heart-fill');
    favoriteBtn.querySelector('.favorite-text').textContent = 'お気に入り済み';
  }
  
  // クリックイベント
  favoriteBtn.addEventListener('click', function() {
    const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    const isFavorite = favorites.includes(movieId);
    
    if (isFavorite) {
      // お気に入りから削除
      const newFavorites = favorites.filter(id => id !== movieId);
      localStorage.setItem('favorites', JSON.stringify(newFavorites));
      
      favoriteBtn.classList.remove('active');
      favoriteBtn.querySelector('i').classList.remove('bi-heart-fill');
      favoriteBtn.querySelector('i').classList.add('bi-heart');
      favoriteBtn.querySelector('.favorite-text').textContent = 'お気に入り';
    } else {
      // お気に入りに追加
      favorites.push(movieId);
      localStorage.setItem('favorites', JSON.stringify(favorites));
      
      favoriteBtn.classList.add('active');
      favoriteBtn.querySelector('i').classList.remove('bi-heart');
      favoriteBtn.querySelector('i').classList.add('bi-heart-fill');
      favoriteBtn.querySelector('.favorite-text').textContent = 'お気に入り済み';
    }
  });
});
</script>

<script src="{% static 'js/movie.js' %}"></script>
{% endblock javascript %}