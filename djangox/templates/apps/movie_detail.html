{% extends '_base.html' %}
{% load static %}

{% block title %}{{ movie.title }}｜チケット購入{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/app/purchase.css' %}">
  <style>
    .favorite-btn {
      border: 2px solid #ffcc00;
      background-color: transparent;
      color: #ffcc00;
      padding: 8px 20px;
      border-radius: 6px;
      font-weight: 600;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .favorite-btn:hover {
      background-color: #ffcc00;
      color: #135034;
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(255, 204, 0, 0.4);
    }
    
    .favorite-btn.active {
      background-color: #ffcc00;
      color: #135034;
    }
    
    .favorite-btn i {
      margin-right: 5px;
      transition: transform 0.3s ease;
    }
    
    .favorite-btn.active i {
      animation: heartBeat 0.6s ease;
    }
    
    @keyframes heartBeat {
      0%, 100% { transform: scale(1); }
      25% { transform: scale(1.3); }
      50% { transform: scale(1.1); }
      75% { transform: scale(1.2); }
    }
    
    .coming-soon-alert {
      background: linear-gradient(135deg, #246c0c, #00350b);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .coming-soon-alert h4 {
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .coming-soon-alert .release-date {
      font-size: 1.2em;
      font-weight: 600;
      margin: 10px 0;
    }
    
    .coming-soon-alert .countdown {
      font-size: 0.9em;
      opacity: 0.9;
    }

    .time-slots-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      width: 100%;
    }

    .no-schedule-message {
      padding: 15px;
      background-color: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 5px;
      color: #856404;
    }
  </style>
{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row g-4">
    <div class="col-md-4 text-center">
      {% if movie.image %}
        <img src="{{ movie.image.url }}" class="img-fluid rounded shadow-sm movie-image" alt="{{ movie.title }}">
      {% else %}
        <img src="{% static 'images/noimage.jpg' %}" class="img-fluid rounded shadow-sm movie-image" alt="画像なし">
      {% endif %}
    </div>

    <div class="col-md-8">
      <div class="d-flex justify-content-between align-items-start mb-3">
        <h2 class="seat-title mb-0">{{ movie.title }}</h2>
        <button class="favorite-btn" id="favoriteBtn" data-movie-id="{{ movie.id }}">
          <i class="bi bi-heart"></i>
          <span class="favorite-text">お気に入り</span>
        </button>
      </div>
      
      <p><strong>ジャンル:</strong> {{ movie.genre }}</p>
      <p><strong>上映時間:</strong> {{ movie.duration }}分</p>
      <p><strong>金額:</strong> ¥{{ movie.price|floatformat:"0" }}</p>

      <div class="mt-4">
        {% if not can_reserve %}
          <!-- 公開予定で予約不可の場合 -->
          <div class="coming-soon-alert">
            <h4><i class="bi bi-calendar-event"></i> 公開予定</h4>
            <div class="release-date">
               公開日: {{ movie.release_date|date:"Y年n月j日(D)" }}
            </div>
            <div class="countdown">
              {{ release_message }}
            </div>
            <hr style="border-color: rgba(255,255,255,0.3); margin: 15px 0;">
            <p class="mb-0" style="font-size: 0.95em;">
              <i class="bi bi-info-circle"></i> この作品は公開日以降にご予約いただけます。<br>
              公開をお楽しみに！
            </p>
          </div>
          <button type="button" class="btn btn-secondary mt-3 px-4" disabled>
            <i class="bi bi-lock-fill"></i> 予約受付前
          </button>
        {% else %}
          <!-- 予約可能な場合（上映中 or 公開日以降） -->
          {% if show_dates %}
            <form method="get" action="{% url 'seat_select' movie.id %}" id="scheduleForm" onsubmit="return validateForm();">
              <p class="fw-bold">上映日を選択してください：</p>
              <div class="btn-group flex-wrap" role="group">
                {% for show in show_dates %}
                  <input type="radio" class="btn-check date-radio" name="date" id="date{{ forloop.counter }}" 
                         value="{{ show.date }}" data-weekday="{{ show.weekday }}" 
                         {% if forloop.first %}checked{% endif %}>
                  <label class="btn btn-outline-primary m-1" for="date{{ forloop.counter }}">
                    {{ show.label }}
                  </label>
                {% endfor %}
              </div>

              <div class="mt-4">
                <p class="fw-bold">上映時間を選択してください：</p>
                <div id="time-slot-container">
                  {% for show in show_dates %}
                    <div class="time-slots-group" data-date="{{ show.date }}" 
                         style="{% if not forloop.first %}display:none;{% endif %}">
                      {% if show.time_slots %}
                        {% for slot in show.time_slots %}
                          <input type="radio" class="btn-check" name="time_slot" 
                                 id="time_{{ forloop.parentloop.counter }}_{{ forloop.counter }}" 
                                 value="{{ slot.time }}" 
                                 {% if forloop.first and forloop.parentloop.first %}checked{% endif %}>
                          <label class="btn btn-outline-secondary time-label" 
                                 for="time_{{ forloop.parentloop.counter }}_{{ forloop.counter }}" 
                                 data-time="{{ slot.time }}">
                            {{ slot.time }}
                            {% if slot.screen %}
                              <br><small class="text-muted">スクリーン{{ slot.screen }}</small>
                            {% endif %}
                            {% if slot.format %}
                              <br><small class="badge bg-info">{{ slot.format }}</small>
                            {% endif %}
                          </label>
                        {% endfor %}
                      {% else %}
                        <div class="no-schedule-message">
                          <i class="bi bi-exclamation-triangle"></i>
                          この日の上映スケジュールは登録されていません。
                        </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              </div>

              <button type="submit" class="btn btn-success mt-4 px-4" id="submitBtn">
                <i class="bi bi-ticket-perforated"></i> 座席を選択する
              </button>
            </form>
          {% elif not show_dates %}
            <div class="alert alert-warning">
              <i class="bi bi-calendar-x"></i>
              現在、この映画の上映スケジュールが登録されていません。
            </div>
          {% else %}
            <div class="alert alert-warning">
              <i class="bi bi-calendar-x"></i>
              現在、上映スケジュールが登録されていません。
            </div>
          {% endif %}
        {% endif %}
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block javascript %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
  crossorigin="anonymous"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const now = new Date();

  // フォーム送信前のバリデーション
  window.validateForm = function() {
    const selectedDate = document.querySelector('input[name="date"]:checked');
    const selectedTimeSlot = document.querySelector('input[name="time_slot"]:checked');
    
    console.log('=== フォーム送信デバッグ ===');
    console.log('選択された日付:', selectedDate ? selectedDate.value : 'なし');
    console.log('選択された時間:', selectedTimeSlot ? selectedTimeSlot.value : 'なし');
    
    if (!selectedDate) {
      alert('上映日を選択してください。');
      return false;
    }
    
    if (!selectedTimeSlot) {
      alert('上映時間を選択してください。');
      return false;
    }
    
    // 選択された日付のグループを確認
    const targetGroup = document.querySelector(`.time-slots-group[data-date="${selectedDate.value}"]`);
    const noScheduleMsg = targetGroup ? targetGroup.querySelector('.no-schedule-message') : null;
    
    if (noScheduleMsg) {
      alert('この日は上映スケジュールが登録されていません。別の日付を選択してください。');
      return false;
    }
    
    console.log('バリデーション成功 - フォーム送信');
    return true;
  };

  // 日付選択時に対応する時間帯を表示
  const dateRadios = document.querySelectorAll('.date-radio');
  const timeGroups = document.querySelectorAll('.time-slots-group');
  const submitBtn = document.getElementById('submitBtn');
  
  if (dateRadios.length > 0 && timeGroups.length > 0) {
    dateRadios.forEach(radio => {
      radio.addEventListener('change', function() {
        const selectedDate = this.value;
        
        // すべての時間帯グループを非表示
        timeGroups.forEach(group => {
          group.style.display = 'none';
        });
        
        // 選択された日付の時間帯グループを表示
        const targetGroup = document.querySelector(`.time-slots-group[data-date="${selectedDate}"]`);
        if (targetGroup) {
          targetGroup.style.display = 'flex';
          
          // 最初の時間帯を自動選択
          const firstTimeSlot = targetGroup.querySelector('input[name="time_slot"]');
          if (firstTimeSlot) {
            firstTimeSlot.checked = true;
            if (submitBtn) submitBtn.disabled = false;
          } else {
            if (submitBtn) submitBtn.disabled = true;
          }
          
          // 過去の時間帯を無効化
          disablePastTimeSlots(selectedDate);
        }
      });
    });
    
    // 初期表示時の処理
    const firstDateRadio = document.querySelector('.date-radio:checked');
    if (firstDateRadio) {
      const selectedDate = firstDateRadio.value;
      disablePastTimeSlots(selectedDate);
    }
  }

  function disablePastTimeSlots(selectedDate) {
    if (!selectedDate) return;

    const todayStr = now.toISOString().split('T')[0]; 
    const isToday = selectedDate === todayStr;

    const visibleGroup = document.querySelector(`.time-slots-group[data-date="${selectedDate}"]`);
    if (!visibleGroup) return;

    visibleGroup.querySelectorAll('.time-label').forEach(label => {
      const time = label.dataset.time;
      const input = document.getElementById(label.htmlFor);

      if (!time || !input) return;

      label.classList.remove('btn-danger');
      label.classList.add('btn-outline-secondary');
      input.disabled = false;

      if (isToday) {
        // 時間文字列から時刻を抽出（例: "09:00～11:00" → "09:00"）
        const startTime = time.split('～')[0].trim();
        const [hour, minute] = startTime.split(':').map(num => parseInt(num));
        
        const slotTime = new Date();
        slotTime.setHours(hour, minute, 0, 0);

        if (slotTime < now) {
          input.disabled = true;
          label.classList.remove('btn-outline-secondary');
          label.classList.add('btn-danger');
          
          // 無効化した時間帯が選択されていたら、次の有効な時間帯を選択
          if (input.checked) {
            input.checked = false;
            const nextValid = visibleGroup.querySelector('input[name="time_slot"]:not(:disabled)');
            if (nextValid) {
              nextValid.checked = true;
            }
          }
        }
      }
    });
  }

  // お気に入り機能
  const favoriteBtn = document.getElementById('favoriteBtn');
  if (favoriteBtn) {
    const movieId = favoriteBtn.dataset.movieId;
    
    // ローカルストレージから状態を読み込み
    function loadFavoriteState() {
      const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
      return favorites.includes(movieId);
    }
    
    // 初期状態を設定
    function updateFavoriteButton() {
      if (loadFavoriteState()) {
        favoriteBtn.classList.add('active');
        favoriteBtn.querySelector('i').classList.remove('bi-heart');
        favoriteBtn.querySelector('i').classList.add('bi-heart-fill');
        favoriteBtn.querySelector('.favorite-text').textContent = 'お気に入り済み';
      } else {
        favoriteBtn.classList.remove('active');
        favoriteBtn.querySelector('i').classList.remove('bi-heart-fill');
        favoriteBtn.querySelector('i').classList.add('bi-heart');
        favoriteBtn.querySelector('.favorite-text').textContent = 'お気に入り';
      }
    }
    
    updateFavoriteButton();
    
    // 映画データを保存
    function saveMovieData() {
      const movieTitle = document.querySelector('h2.seat-title')?.textContent.trim() || 'タイトル不明';
      const movieImageElement = document.querySelector('.movie-image');
      const movieImage = movieImageElement ? movieImageElement.src : '/static/images/noimage.jpg';
      
      const movieData = {
        id: movieId,
        title: movieTitle,
        image_url: movieImage
      };
      
      localStorage.setItem(`movie_${movieId}`, JSON.stringify(movieData));
      console.log('映画データを保存しました:', movieData);
    }
    
    // クリックイベント
    favoriteBtn.addEventListener('click', function() {
      const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
      const isFavorite = favorites.includes(movieId);
      
      if (isFavorite) {
        // お気に入りから削除
        const newFavorites = favorites.filter(id => id !== movieId);
        localStorage.setItem('favorites', JSON.stringify(newFavorites));
      } else {
        // お気に入りに追加
        favorites.push(movieId);
        localStorage.setItem('favorites', JSON.stringify(favorites));
        
        // 映画データを保存
        saveMovieData();
      }
      
      updateFavoriteButton();
      
      // 他のページに変更を通知
      window.dispatchEvent(new CustomEvent('favoriteChanged', { 
        detail: { movieId, isFavorite: !isFavorite } 
      }));
    });
    
    // 他のページからの変更を監視
    window.addEventListener('favoriteChanged', function(e) {
      if (e.detail.movieId === movieId) {
        updateFavoriteButton();
      }
    });
  }
});
</script>
{% endblock javascript %}